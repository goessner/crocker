<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <title>4bar</title>
  <style> canvas { border: 1px solid #000; } </style>
  <script src='../g2/dist/g2.js'></script>
  <script src='../g2-mec/src/g2.mec.js'></script>
  <script src='fourbar.js'></script>
</head>

<body>
  <h1>Draw Crank-Rocker</h1>
  <div id="app">
    <canvas id="c" width="400", height="300"></canvas><br>
  </div>
  <script>
var app = {
   crdata: { a:100, b:200, c:200, d:100 },
   cr: null,
   ctx: document.getElementById("c").getContext("2d"),
   g: g2(),
   bg:  g2(),
   fbg: g2(),
   dirty: true,
   go: false,

   init: function() {
      this.fb = Fourbar.create(this.fbdata).compile().calc();
      document.getElementById("h").innerHTML = this.fb.typestr();
      document.getElementById("stopgo").onclick = this.stopgo.bind(this);
      this.renderHdl = this.render.bind(this);
      this.fb.onCycle(this.cycleHdl = this.cycle.bind(this));
      this.fbg
          .cartesian()
          .clr()
          .pan(200,200)
          .style({sh:[5,5,5,"#888"]})
          .use(this.mov)
          .use(this.bg);
      this.render();
   },
   stopgo: function() {
      this.go = !this.go;
      document.getElementById("stopgo").innerHTML = this.go ? "stop" : "run";
      if (this.go) this.render();
   },
   cycleHdl: null,
   cycle: function(cyc) {
      if (cyc.cnt === 0) {
         if (cyc.state === "beg")
            this.curve = [];
      }
      else {
         console.log("state:"+cyc.state+", cnt:"+cyc.cnt);
         this.fb.onCycle(this.cycleHdl);  // remove handler ...
      }
   },
   renderHdl: null,
   render: function() {
      var fb = this.fb;
      if (this.dirty) {
         this.bg.del()
             .use("nodfix",fb.A0)
             .use("nodfix",fb.B0);
         this.dirty = false;
      }
      fb.step().calc();
      if (this.fb.cycle.cnt === 0 && this.curve) {
         this.curve.push(fb.C.x,fb.C.y);
//         console.log("!");
      }
      this.mov.del()
         .ply(this.curve,true,{ls:"#888",lw:2,fs:"orange"})
         .bar(fb.A0,{x:fb.A.x-fb.A0.x,y:fb.A.y-fb.A0.y},fb.calc === Fourbar.prototype.calcCrankRocker ? {fs:"green"} : null)
         .bar(fb.A,{x:fb.B.x-fb.A.x,y:fb.B.y-fb.A.y})
         .bar(fb.B0,{x:fb.B.x-fb.B0.x,y:fb.B.y-fb.B0.y},fb.calc === Fourbar.prototype.calcRockerCrank ? {fs:"green"} : null)
         .use("nod",fb.A)
         .use("nod",fb.B)
         .use("nod",fb.C);
      this.fbg.exe(this.ctx);
      if (this.go) requestAnimationFrame(this.renderHdl);
   }
}
app.init();
  </script>
</body>
</html>
